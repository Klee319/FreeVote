# プロダクト仕様書: 日本語アクセント投票サイト

**バージョン**: 1.0  
**最終更新日**: 2025-08-28

## 1. 目的とスコープ

### 解決する課題
日本語のアクセントパターンが地域によって異なることを定量的に調査・可視化するため、多くの人が気軽に参加できるクラウドソーシング型の投票プラットフォームが必要。

### ターゲットユーザー
- **投票者**: 日本語のアクセントに関心がある一般ユーザー（ログイン不要）
- **投稿者**: 新しい調査語を追加したい研究者・教育関係者（ログイン必須）
- **閲覧者**: アクセント分布データを参照したい言語学関係者

### この仕様書の読者
開発者、QAエンジニア、プロダクトオーナー、言語学監修者

## 2. 機能一覧

- `F-01`: 語の検索・一覧表示 — キーワードで語を検索し、結果を一覧表示する
- `F-02`: アクセント投票 — 4つのアクセント型から1つを選択して投票する
- `F-03`: アクセント分布可視化 — 都道府県別の投票結果を地図と棒グラフで表示する
- `F-04`: 人気語ランキング表示 — 投票数の多い語をランキング形式で表示する
- `F-05`: 新着語一覧表示 — 新しく追加された語を時系列で表示する
- `F-06`: 新語投稿 — ログインユーザーが新しい調査語を投稿する
- `F-07`: ユーザー認証 — メール認証によるログイン/ログアウト機能
- `F-08`: 投稿承認管理 — 管理者による新語投稿の承認・却下

## 3. 機能詳細

### F-01: 語の検索・一覧表示

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 検索キーワード | 文字列 / 50文字以内 / ひらがな・カタカナ・漢字 | 部分一致検索 |
| **入力** | ページ番号 | 整数 / 1以上 | デフォルト1 |
| **処理** | 検索実行 | 見出し語・読み・別表記から部分一致検索を行う | |
| **出力 (正常時)** | 検索結果一覧 | 語ID、見出し語、読み、投票数、更新日時を1ページ20件で表示 | |
| **出力 (異常時)** | 検索結果なし | "該当する語が見つかりませんでした" メッセージを表示 | |

### F-02: アクセント投票

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | アクセント型選択 | enum: atamadaka/heiban/nakadaka/odaka | 4つの選択肢から1つ必須 |
| **入力** | 都道府県 | enum: 都道府県コード | 必須選択 |
| **入力** | 年代 | enum: 10s/20s/30s/40s/50s/60s/70s+ | 任意選択 |
| **処理** | 投票記録 | デバイスIDと語IDの組み合わせで重複チェック後、投票を記録 | |
| **処理** | 統計更新 | word_pref_statsテーブルの集計値をリアルタイム更新 | |
| **出力 (正常時)** | 投票完了通知 | "投票ありがとうございました" とアンドゥボタン（5秒間）を表示 | |
| **出力 (異常時)** | 重複投票エラー | "この語には24時間以内に投票済みです" メッセージを表示 | |

### F-03: アクセント分布可視化

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 語ID | 整数 / 正の値 | URLパスパラメータ |
| **入力** | 都道府県フィルタ | enum: 都道府県コード | 任意、デフォルトは全国 |
| **処理** | 分布データ取得 | word_pref_statsから都道府県別・アクセント型別の投票数を取得 | |
| **出力 (正常時)** | 日本地図表示 | 各都道府県を最多アクセント型の色で塗り分け | ECharts使用 |
| **出力 (正常時)** | 棒グラフ表示 | 選択都道府県内の4アクセント型別投票率を棒グラフ表示 | |
| **出力 (正常時)** | アクセント型カード | モーラ分割された4つのアクセント型を線描画で表示 | |

### F-04: 人気語ランキング表示

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 期間指定 | enum: 7d/30d/all | デフォルト7d |
| **処理** | ランキング計算 | 指定期間内の投票数でソートしてTOP50を取得 | |
| **出力 (正常時)** | ランキング一覧 | 順位、語、読み、投票数、前回順位との差を表示 | |

### F-05: 新着語一覧表示

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **処理** | 新着語取得 | 承認済み語を作成日時降順で取得 | |
| **出力 (正常時)** | 新着一覧 | 語、読み、投稿者、承認日を1ページ20件で表示 | |

### F-06: 新語投稿

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 見出し語 | 文字列 / 30文字以内 / ひらがな・カタカナ・漢字 | 必須 |
| **入力** | 読み | 文字列 / 50文字以内 / ひらがな・カタカナ | 必須 |
| **入力** | 別表記 | 文字列 / 100文字以内 / カンマ区切り | 任意 |
| **入力** | カテゴリ | enum: 一般語/専門語/方言/固有名詞 | 必須 |
| **入力** | 初期アクセント型 | enum: atamadaka/heiban/nakadaka/odaka | 必須、投稿者の初期投票 |
| **入力** | 都道府県 | enum: 都道府県コード | 必須 |
| **入力** | 年代 | enum: 10s/20s/30s/40s/50s/60s/70s+ | 任意 |
| **処理** | 重複チェック | 見出し語・読みの組み合わせで既存語との重複を確認 | |
| **処理** | 承認待ちステータス設定 | status='pending'で投稿を保存 | |
| **出力 (正常時)** | 投稿完了通知 | "投稿ありがとうございます。承認をお待ちください。" | |
| **出力 (異常時)** | 重複語エラー | "似た語が既に登録されています: [候補リスト]" | |

### F-07: ユーザー認証

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | メールアドレス | 文字列 / RFC5322準拠 | 必須 |
| **入力** | パスワード | 文字列 / 8文字以上 / 英数字記号 | 必須 |
| **処理** | 認証実行 | Supabase Authを使用したメール認証 | |
| **出力 (正常時)** | ログイン成功 | JWTトークンをHTTPOnlyCookieに保存、ダッシュボードへリダイレクト | |
| **出力 (異常時)** | 認証失敗 | "メールアドレスまたはパスワードが間違っています" | |

### F-08: 投稿承認管理

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 承認アクション | enum: approve/reject | 管理者のみ |
| **入力** | 承認コメント | 文字列 / 200文字以内 | 却下時は必須 |
| **処理** | ステータス更新 | pending → approved/rejected | |
| **処理** | 語マスタ登録 | 承認時はwordsテーブルに本登録 | |
| **出力 (正常時)** | 承認完了通知 | 投稿者にメール通知を送信 | |

## 4. ビジネスルール

- **重複投票制限**: 1デバイス1語につき24時間に1回まで投票可能（Cookie + LocalStorage ID管理）
- **重複語判定**: 見出し語と読みの組み合わせが完全一致する場合は重複とみなす
- **アクセント型固定**: 全ての語に対して頭高・平板・中高・尾高の4型を固定で提供
- **投票の上書き**: 24時間経過後の再投票は前回投票を上書きし、統計を再計算
- **モデレーション**: 新語投稿は管理者承認制、承認から24時間以内に公開
- **地域統計**: 投票数10未満の都道府県は統計表示時に「データ不足」表示
- **ボット対策**: 同一IPから1時間に10投票以上はブロック、Turnstileによる検証

## 5. 設定ファイル・環境変数

| 項目名 | デフォルト値 | 必須 | 説明 |
|:---|:---:|:---:|:---|
| `DATABASE_URL` | - | Yes | PostgreSQLデータベースの接続URL |
| `REDIS_URL` | - | Yes | Redis（キャッシュ・レート制限）の接続URL |
| `SUPABASE_URL` | - | Yes | Supabase認証サービスのURL |
| `SUPABASE_ANON_KEY` | - | Yes | Supabase匿名アクセスキー |
| `SUPABASE_SERVICE_KEY` | - | Yes | Supabaseサービスアカウントキー |
| `TURNSTILE_SITE_KEY` | - | Yes | CloudflareTurnstileのサイトキー |
| `TURNSTILE_SECRET_KEY` | - | Yes | CloudflareTurnstileのシークレットキー |
| `RATE_LIMIT_VOTES_PER_HOUR` | `10` | No | 1時間あたりの投票制限数 |
| `PAGINATION_LIMIT` | `20` | No | 1ページあたりの表示件数 |
| `CACHE_TTL_SECONDS` | `300` | No | キャッシュの有効期限（秒） |

## 6. 非機能要件

| 項目 | 要求レベル | 備考 |
|:---|:---|:---|
| **パフォーマンス** | 各画面表示2秒以内、投票処理1秒以内 | |
| **同時接続数** | 1000人の同時アクセスに対応 | |
| **データ整合性** | 投票統計の不整合は日次バッチで修正 | |
| **セキュリティ** | OWASP Top10対策、SQLインジェクション防止 | |
| **アクセシビリティ** | WCAG 2.1 AA準拠 | |
| **ログ記録** | 全API呼び出し、エラー、投票行動をログ出力 | |
| **バックアップ** | データベースの日次自動バックアップ | |

## 7. 用語集

- **モーラ**: 日本語の音韻的単位（拍）。「きゃ」「ん」「っ」もそれぞれ1モーラ
- **頭高型**: 第1モーラが高く、第2モーラ以降が低いアクセント型
- **平板型**: 第1モーラが低く、第2モーラ以降が高く、語末で下がらないアクセント型
- **中高型**: 語の途中で高→低に下がるアクセント型
- **尾高型**: 語末モーラが高く、助詞接続で下がるアクセント型
- **デバイスID**: Cookie + LocalStorageで生成される一意識別子
- **拗音**: ャュョァィゥェォなど、直前の子音と結合して1モーラを構成する音

## 8. 外部依存

- **Supabase Auth**: ユーザー認証・セッション管理
- **Cloudflare Turnstile**: ボット検証サービス
- **PostgreSQL**: メインデータベース
- **Redis**: キャッシュ・セッション・レート制限
- **ECharts**: 日本地図・グラフ表示ライブラリ

## 9. 技術アーキテクチャ概要

### フロントエンド
- Next.js 14 (App Router)
- TypeScript
- Tailwind CSS
- TanStack Query (状態管理・キャッシュ)
- ECharts (可視化)

### バックエンド
- Next.js API Routes
- Prisma ORM
- PostgreSQL (メインDB)
- Redis (キャッシュ)

### 認証・セキュリティ
- Supabase Auth
- Cloudflare Turnstile
- Rate Limiting (Redis)

## 10. 開発フェーズ

### フェーズ1: MVP基盤 (2週間)
- データベース設計・構築
- 基本認証機能
- 語の検索・詳細表示
- 基本投票機能

### フェーズ2: 投票システム完成 (2週間)
- アクセント型可視化（線描画）
- 都道府県別統計表示
- デバイス管理・重複投票制御
- ボット対策実装

### フェーズ3: 管理機能 (1週間)
- 新語投稿・承認システム
- ランキング・新着一覧
- 管理者ダッシュボード

### フェーズ4: 最適化・公開準備 (1週間)
- パフォーマンス最適化
- ログ・監視設定
- セキュリティテスト

## 11. 確認が必要な項目

以下の項目は実装時にステークホルダーとの詳細確認が必要です：

1. **アクセント型の表記方法**: 線描画の具体的なデザイン仕様
2. **地図の色分け詳細**: どのアクセント型をどの色にするか
3. **投票データの扱い**: 個人情報保護法への対応方針
4. **管理者権限**: 管理者アカウントの作成・管理方法
5. **エラー処理**: 具体的なエラーメッセージの文言
6. **メール通知**: 承認通知メールのテンプレート
7. **データ削除**: GDPR対応での個人データ削除手順

## 12. 改訂履歴

| 版 | 日付 | 変更内容 | 担当者 |
|:---|:---|:---|:---|
| 1.0 | 2025-08-28 | 初版作成 | Claude Code |
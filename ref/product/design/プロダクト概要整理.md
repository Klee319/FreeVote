# みんなの投票 — プロダクト概要整理

この仕様書は、**アクセント辞典**を拡張して汎用投票プラットフォーム「みんなの投票」を実現するための詳細な設計ドキュメントです。既存の実装は Next.js 14 + React を用いたフロントエンドと Node.js/Express + Prisma を用いたバックエンドで構成されているため、本仕様もそのアーキテクチャを前提としています。アクセント投票、SNSシェア、地図表示といった差別化機能を活かしながら、誰でも楽しめる投票サイトへ拡張します。既存実装をgitで確認する必要はありません。ローカル内には既存プロジェクトをArchiveフォルダに保存しているので適宜参考にしてください。（あくまで参考としての利用に限定しコピペは禁止）

## 1 サイト概要

| 項目  | 内容  |
| --- | --- |
| **サイト名（仮称）** | **みんなの投票** |
| **目的** | 誰でも簡単に投票に参加でき、SNS で拡散しやすいプラットフォームを提供する。アクセント投票はユニークなカテゴリとして残すものの、時事・エンタメ・雑学などあらゆるテーマを扱う。 |
| **ターゲットユーザー** | 投票そのものや結果の傾向分析に興味がある一般ユーザー。 |
| **デザイン方針** | ポップでモダンな UI を採用し、堅苦しさを感じさせない色使いやレイアウトにする。 |

## 2 ユーザーと権限モデル

「みんなの投票」ではゲストでも投票に参加できますが、登録することでさらに多くの機能が使えます。アカウント登録時には年齢区分（10代刻み）、都道府県、性別（男性／女性／その他）を必須入力とし、X・Instagram・TikTok との連携ログインも提供します。

| ロール | 概要  |
| --- | --- |
| **ゲストユーザー** | 登録やログインをせずに投票に参加できる。投票テーマの提案も可能。結果閲覧は総合結果のみで、年齢・地域・性別別の詳細統計や地図表示、ランキングなどは利用できない。 |
| **登録ユーザー** | メール登録または SNS 連携でログインしたユーザー。年齢区分・都道府県・性別を登録する。投票と詳細統計閲覧、SNS シェアによる紹介人数の計測、紹介ランクの確認など全機能を利用できる。 |
| **管理者** | /admin 以下のダッシュボードにアクセスでき、投票の作成・編集・削除、提案の採用/却下、ユーザー管理、統計閲覧、データインポート、シェア文テンプレート管理などを行う。 |

認証は JWT ベースで実装し[\[2\]](https://github.com/Klee319/FreeVote/blob/master/ref/product/design/api_specification.md#L7-L13)、管理者のみが管理 API にアクセスできるようにします。

## 3 データモデル

既存の Words／Votes テーブルはアクセント投票に特化しているため、汎用投票用に以下の共通テーブルを設計します。アクセント投票は isAccentMode フラグで識別し、必要に応じて wordId を参照します。

### 3.1 Polls テーブル

| カラム名 | 型   | 説明  |
| --- | --- | --- |
| id  | UUID/Int | 主キー |
| title | String | 投票タイトル |
| description | Text | 投票説明 |
| isAccentMode | Boolean | アクセント投票か通常投票かを示すフラグ |
| wordId | Int? | アクセント投票の場合の単語 ID（通常投票は null） |
| options | JSONB | 選択肢オブジェクトの配列（最大 4 件）。アクセントモード時は固定。 |
| deadline | Timestamp | 投票締切日時 |
| shareMessage | String | シェア用メッセージのテンプレート |
| shareHashtags | String | シェア用ハッシュタグ（カンマ区切り） |
| thumbnailUrl | String | 投票トップ画面用サムネイル画像 URL |
| optionThumbnails | JSONB | 各選択肢のサムネイル画像 URL 配列 |
| categories | String\[\] | 投票のカテゴリ（複数可） |
| createdAt | Timestamp | 作成日時 |
| createdBy | UUID | 作成した管理者のユーザー ID |

options フィールドは各選択肢を以下のように表現します。アクセントモード時のみ音高パターンやボイスサンプルを保持します。

{  
"label": "選択肢Aの表示名",  
"thumbnailUrl": "<https://example.com/optionA.png>",  
"pitchPattern": \[0, 1, 1, 0\],  
"voiceSampleUrl": "<https://example.com/sampleA.mp3>"  
}

### 3.2 PollVotes テーブル

| カラム名 | 型   | 説明  |
| --- | --- | --- |
| id  | UUID/Int | 主キー |
| pollId | UUID/Int | Polls への外部キー |
| option | Int | 選択肢インデックス（0〜3） |
| prefecture | String | 都道府県コード |
| ageGroup | String? | 年代（10代刻み：10代・20代…） |
| gender | String? | 性別（男性／女性／その他） |
| userId | UUID? | 登録ユーザーの場合のユーザー ID。ゲスト投票時は null。 |
| userToken | String | 匿名ユーザー識別用トークン（投票ごとのセッション維持に利用） |
| votedAt | Timestamp | 投票日時 |

### 3.3 UserVoteRequests テーブル

| カラム名 | 型   | 説明  |
| --- | --- | --- |
| id  | UUID/Int | 主キー |
| title | String | 提案タイトル |
| description | Text | 詳細説明 |
| options | JSONB | 選択肢候補の配列 |
| count | Int | 賛同数（いいね数） |
| createdAt | Timestamp | 提案日時 |

### 3.4 Users テーブル

| カラム名 | 型   | 説明  |
| --- | --- | --- |
| id  | UUID/Int | 主キー |
| username | String? | ユーザー名（任意） |
| email | String? | メールアドレス（メール登録の場合） |
| passwordHash | String? | パスワードハッシュ（メール登録の場合） |
| ageGroup | String | 年代区分（10代、20代…） |
| prefecture | String | 都道府県コード |
| gender | String | 性別（男性／女性／その他） |
| provider | String? | SNS 連携プロバイダー（twitter、instagram、tiktok など） |
| providerId | String? | 外部サービス側のユーザー ID |
| referralCount | Int | シェアしたリンクから流入したユニーク訪問者数（初期値 0） |
| createdAt | Timestamp | 登録日時 |
| updatedAt | Timestamp | 更新日時 |

### 3.5 UserReferrals テーブル

シェアリンク経由の流入を記録します。重複カウントを防ぐために、訪問者には匿名トークンを割り当てます。

| カラム名 | 型   | 説明  |
| --- | --- | --- |
| id  | UUID/Int | 主キー |
| userId | UUID/Int | シェアした登録ユーザーの ID |
| pollId | UUID/Int | どの投票へのシェアか |
| visitorToken | String | 流入した訪問者を識別する匿名トークン |
| referredAt | Timestamp | 流入日時 |

## 4 API 設計

すべての API は /api 配下に配置し、共通のレスポンス構造を用います[\[3\]](https://github.com/Klee319/FreeVote/blob/master/ref/product/design/api_specification.md#L20-L39)。下表では主要エンドポイントを分類します。

### 4.1 投票取得・参加

| メソッド | エンドポイント | 説明  |
| --- | --- | --- |
| GET | /api/polls | 公開中の投票一覧を取得。クエリに category、sort、search を指定可能。sort は new（新着順）、trending（急上昇）、voteCount（投票数順）から選択し、search が空の場合は sort に従って全投票を返す。 |
| GET | /api/polls/:id | 投票の詳細と集計情報を取得。アクセントモードの場合は音高パターンやアクセント型候補も含む[\[4\]](https://github.com/Klee319/FreeVote/blob/master/ref/product/design/api_specification.md#L89-L147)。 |
| POST | /api/polls/:id/votes | 投票を記録する。ボディには option、prefecture、ageGroup、gender、userToken を含める。初回投票時は userToken を生成してレスポンスで返す。 |
| GET | /api/polls/:id/top-by-prefecture | 都道府県ごとの最多投票選択肢を取得し、地図の色分けに利用する。 |
| GET | /api/polls/:id/stats | 詳細統計を返す。クエリに filterBy（age / gender / prefecture）を指定し、年齢別・性別別・県別を切り替える。 |

### 4.2 投票作成・管理（管理者のみ）

| メソッド | エンドポイント | 説明  |
| --- | --- | --- |
| POST | /api/admin/polls | 新しい投票を作成。フォームデータまたは JSON 形式で送信。選択肢は最大 4 件。アクセントモード時は wordId を指定し、選択肢はバックエンドで自動設定。 |
| PUT | /api/admin/polls/:id | 既存投票の更新。締切後は編集不可。 |
| DELETE | /api/admin/polls/:id | 投票の論理削除。 |
| GET | /api/admin/requests | ユーザー提案の一覧取得。 |
| POST | /api/admin/import | JSON ファイルから複数投票を一括登録。 |

### 4.3 投票提案・ユーザーアクション

| メソッド | エンドポイント | 説明  |
| --- | --- | --- |
| POST | /api/requests | ユーザーが新しい投票テーマを提案。ボディに title、description、options を含む。 |
| POST | /api/requests/:id/like | 提案に「いいね」を付け、賛同数を増やす。 |

### 4.4 認証関連

| メソッド | エンドポイント | 説明  |
| --- | --- | --- |
| POST | /api/auth/register | 新規ユーザー登録。メール登録の場合は email・password、SNS 連携の場合は provider・providerId を受け取り、必須属性 (ageGroup、prefecture、gender) と共にユーザーを生成する。登録後にアクセストークンを返す。 |
| POST | /api/auth/login | メール登録ユーザーのログイン。アクセストークンとリフレッシュトークンを発行する。 |
| POST | /api/auth/social-login | SNS 連携ログイン。外部認証トークンを検証し、既存ユーザーと照合してトークンを返す。存在しない場合は登録を促す。 |
| POST | /api/auth/logout | ログアウトし、アクセストークンおよびリフレッシュトークンを無効化する。 |
| POST | /api/auth/refresh | リフレッシュトークンから新しいアクセストークンを発行する。 |
| GET | /api/auth/me | ログイン中のユーザー情報（id、username、ageGroup、prefecture、gender、referralCount）を返す。 |

### 4.5 紹介・シェア関連

| メソッド | エンドポイント | 説明  |
| --- | --- | --- |
| POST | /api/referrals/visit | シェアリンクからアクセスした際に呼び出す。ボディに sharedBy（ユーザー ID）と pollId、訪問者の visitorToken を含む。重複がなければ UserReferrals に記録し、該当ユーザーの referralCount をインクリメントする。 |
| GET | /api/users/:id/referrals | 指定ユーザーの紹介人数と、全ユーザー中でのランキング位置を返す。 |
| GET | /api/polls/:id/share-message | シェア用メッセージを取得。クエリに option（選択した選択肢インデックス）を渡し、得票分布を元に接戦か大差かを判定して文面を生成する。 |

## 5 フロントエンド構成

Next.js 14 の App Router を利用し、/app 以下にページとレイアウトを構築します。

### 5.1 トップページ (/)

- **ヘッダー**にロゴ、検索窓、フィルタ/ソートボタン、ユーザーメニューを配置します。ユーザーメニューではログイン/登録リンクまたはログイン済みユーザー名と紹介ランク・紹介人数を表示します。投票提案ボタンもここに含めます。従来のタブメニューは廃止します。
- **急上昇ランキング／新着投票**を上部にカード形式で表示します。ランキングデータは /api/polls?sort=trending で取得し、投票数や増加率を元に並び替えます。ユーザー紹介ランキングをサイドバーに表示し、紹介人数に応じてバッジを付与します。
- **カテゴリ別タブ**でアクセント投票やエンタメ・ニュース等に絞り込み可能にします。タブを切り替えると category クエリを付けて再取得します。

### 5.2 投票詳細ページ (/polls/\[id\])

- タイトル、説明、締切までのカウントダウン、選択肢を表示します。アクセントモードの場合、各選択肢の下に音高グラフとイントネーション別の再生ボタンを表示します[\[4\]](https://github.com/Klee319/FreeVote/blob/master/ref/product/design/api_specification.md#L89-L147)。
- 投票ボタンを押すと、ゲストは属性ゲート（都道府県必須・年代 10 歳刻み・性別 3 択）を表示し、初回のみ入力を求めます。登録ユーザーは登録済みの属性を使用します。
- 投票完了後は簡易結果を表示し、登録ユーザーには詳細統計ボタンと SNS シェアボタンを表示します。ゲストユーザーは総合結果のみ表示し、登録を促します。
- SNS シェアボタンは /api/polls/:id/share-message?option=&lt;index&gt; を呼び出して文面を取得し、接戦か大差かに応じて文章を変えます。

### 5.3 結果統計ページ (/polls/\[id\]/stats)

- **総合順位**をデフォルト表示し、登録ユーザーはフィルタドロップダウンで年代別・性別別・県別を切り替えられます。ゲストユーザーは総合順位のみ閲覧でき、登録を促すメッセージを表示します。
- **地図表示**では /api/polls/:id/top-by-prefecture から取得したデータで日本地図を色分けします。投票先の数だけ色を用意し、必要に応じて県名ラベルを重ねます。
- **テーブル/グラフ表示**として総投票数や割合、急上昇スコアを表やグラフで表示し、投票数で並べ替えることも可能にします。

### 5.4 投票提案ページ (/request)

ユーザーが新しい投票テーマを提案できるページです。タイトル・説明・選択肢（任意）・カテゴリを入力するフォームを設置し、送信後はサンクスページに遷移して提案 ID と共有 URL を表示します。ユーザー提案は管理者が審査し、採用されたものを公開投票として作成できます。

### 5.5 管理者ダッシュボード (/admin)

ダッシュボード内に複数タブを設けます：

- **ホームタブ** — 既存投票一覧、急上昇投票、締切間近投票、ユーザーリクエスト数などを表示します。
- **投票作成タブ** — 新規投票フォーム。アクセントモードのトグル、タイトル、説明、選択肢（最大 4）、カテゴリ、締切、シェアメッセージ・ハッシュタグ、サムネイル画像などを設定し、プレビュー機能で公開前に確認できます。
- **リクエスト管理タブ** — ユーザー提案の一覧と賛同数を表示し、採用／却下を行います。採用した提案は投票作成フォームに反映できます。
- **統計タブ** — サイト全体の投票数推移やユーザー登録数、シェア率などをグラフで表示し、期間指定フィルタも付けます。
- **データ管理タブ** — Polls・PollVotes データの閲覧・編集・削除に加えて JSON インポート/エクスポート機能を提供します。
- **セキュリティタブ** — レート制限や CORS 設定、JWT 有効期間などの環境設定を表示し、アクセストークンの失効処理や監査ログ閲覧を行います。

### 5.6 ログイン／登録ページ (/login, /register)

- **登録ページ**では、メールアドレス + パスワードでアカウントを作成するフォームを用意します。入力項目は username（任意）、email、password、ageGroup、prefecture、gender の 6 項目で、登録後に /api/auth/register を呼び出して自動ログインさせます。
- **SNS 連携登録**では、X・Instagram・TikTok のボタンを配置し、クリックすると OAuth 認可ページへリダイレクトします。認証後は /api/auth/social-login を呼び出してユーザーを作成し、必要であれば追加入力ページで ageGroup・prefecture・gender を補完します。
- **ログインページ**ではメールアドレス + パスワードでログインするフォームを設置し、/api/auth/login を呼び出してアクセストークンとリフレッシュトークンを受け取ります。SNS ログインボタンも提供します。ログイン中にこのページを訪問した場合はトップページにリダイレクトします。

## 6 セッション維持と Magic Link

SNS アプリ内ブラウザではクッキーが保持されない問題があり、セッションが切れやすいので、以下の対策を採用します。

- **Magic Link 方式** — 投票ページや結果ページへの URL に短期有効なトークンを付与し、そのトークンにユーザー属性や未完了の投票データを暗号化して含めます。外部ブラウザで開いても状態を復元できるようにします。
- **外部ブラウザ誘導** — アプリ内ブラウザで開いていることを検知した場合、「外部ブラウザで開く」バナーを表示し、ユーザーがデフォルトブラウザで開き直せるようにします。
- **匿名ユーザートークン** — ゲスト投票時に一意の userToken を生成し、PollVotes に保存します。トークンは LocalStorage に保持し、再訪時の投票済み判定に利用します。

## 7 アクセントモードの特化仕様

アクセント投票は完全にオプション化され、通常投票と同じ UI に音高グラフやボイスサンプルが追加される形とします。

- **投票作成時**に「アクセントモードを有効にする」トグルを設け、ON の場合は isAccentMode = true とします。アクセントモードが有効な投票では、選択肢設定欄の下に音高パターン入力欄とボイスサンプル生成ボタンを追加表示します。管理者は pitchPattern を入力するか既存の単語から候補を選択できます。保存時に options\[\].pitchPattern と voiceSampleUrl を Polls に格納します。
- **投票詳細画面**では各選択肢ごとに音高グラフとメロディラインを表示し、スピーカーアイコンでサンプル音声を再生します。これによりユーザーはアクセントの違いを直感的に理解できます。
- **統計ページ**では県別色分けや年齢別・性別別集計に加え、アクセント型ごとの支持率を表示可能にします。アクセントモード ON の場合のみ地図やグラフにアクセント情報を反映します。

## 8 ランキングおよび検索機能

- **急上昇ランキング** — 投票数の増加率や閲覧数を基にスコア化し、直近 7 日および 30 日単位で計算します。パラメータはバックエンドで調整でき、運用中に最適化します。
- **並べ替えオプション** — sort クエリパラメータに new（新着順）、voteCount（総投票数順）、trending（急上昇順）を指定できます。デフォルトは急上昇順です。投票数による並び替えも可能にします。
- **キーワード検索** — search クエリでタイトル・説明・カテゴリに部分一致する投票のみを返します。空の場合は全投票を表示し、指定した sort に従って並べ替えます。

## 9 テストおよび CI/CD

- **バックエンドテスト** — 投票作成、投票送信、統計取得、提案管理など主要 API について、Jest または Vitest で単体テストと統合テストを実装します。型安全のために Zod/TypeScript のスキーマ検証を併用します。
- **フロントエンドテスト** — 主要コンポーネントに対して Storybook と React Testing Library を用いた UI テストを作成し、ユーザー操作や表示に関する回帰を防ぎます。
- **CI/CD** — GitHub Actions で自動テスト、Lint、ビルドを実行し、main ブランチへのマージ時に CI が成功することを確認します。

## 10 今後の拡張ポイント

- **AB テスト機能** — 投票表示順やシェア文面をランダムに出し分け、クリック率やシェア率を計測する仕組みを導入します。
- **多言語対応** — 日本語以外のユーザー向けに国際化を行い、next-i18next などで翻訳を管理します。
- **チャットボット連携** — Line Bot などと連携し、チャット経由で投票提案を受け付けたり、結果を通知したりできるようにします。
- **広告・マネタイズ** — 投票結果ページやランキングページに広告枠を設置し、スポンサー掲載による収益化を検討します。

## 11 紹介ランクとシェアメッセージ生成

### 11.1 紹介ランク

1. 登録ユーザーが投票リンクを SNS でシェアすると、リンクに sharedBy パラメータが付与されます（例：/polls/123?sharedBy=&lt;userId&gt;）。
2. 訪問者がこのリンクからアクセスすると、フロントエンドは POST /api/referrals/visit を呼び出し、sharedBy と pollId、訪問者の visitorToken を送信します。重複しない訪問なら UserReferrals に記録し、該当ユーザーの referralCount を増やします。
3. referralCount に応じて紹介ランク（ブロンズ、シルバー、ゴールド、プラチナなど）を付与し、トップページやプロフィールにバッジとして表示します。ランク閾値は運営が設定します。管理者はランキング一覧をダッシュボードで確認できます。

### 11.2 シェアメッセージ生成

投票を SNS にシェアする際、投票状況に応じて文面を動的に変更し、拡散力を高めます。

1. シェアボタンを押すとフロントエンドは /api/polls/:id/share-message?option=&lt;index&gt; を呼び出し、サーバーは投票状況を取得します。
2. 接戦かどうかは上位 2 つの選択肢の得票率差が指定した閾値（例：5 %）未満かどうかで判定します。閾値は環境変数または管理画面から変更できます。
3. **接戦の場合** — 投票者の選択肢が僅差で 2 番手の場合、「あと X % で B を超えます！」といった煽り文句を生成します。投票者の選択肢がトップの場合は「A が僅差でリード中！油断すると逆転されるかも？」などにします。
4. **大差の場合** — 得票率差が閾値以上なら「私は◯◯に投票しました！みんなも投票しよう！」といったシンプルな文面にし、投票結果をぼかして投票意欲を保ちます。
5. 生成されたメッセージに投票タイトルや選択肢名、ハッシュタグを挿入し、SNS シェア用 URL と共にフロントエンドに返します。ユーザーはこの文面を用いて X や Instagram ストーリーズなどへ投稿できます。


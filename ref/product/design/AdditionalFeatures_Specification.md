# 追加機能仕様書: 日本語アクセント投票サイト

**バージョン**: 1.0  
**最終更新日**: 2025-08-29

## 1. 目的とスコープ

### 解決する課題
既存の基本投票機能に加えて、ユーザビリティの向上、地域特性の可視化強化、システム管理機能の充実を図る。

### 対象機能
- Cookie認証システム（JWT認証からの移行）
- 都道府県別ランキング表示機能
- 日本地図でのアクセント分布可視化
- 管理者による単語直接追加機能
- 方言モード対応
- 法的文書整備

### この仕様書の読者
開発者、QAエンジニア、プロダクトオーナー、システム管理者

## 2. 機能一覧

- `F-09`: Cookie認証システム — 初回訪問時の属性登録とCookie管理
- `F-10`: 都道府県別ランキング表示 — 地域ごとの人気語ランキング機能  
- `F-11`: 日本地図アクセント分布可視化 — 各都道府県の主要アクセントの地図表示
- `F-12`: 管理者単語直接追加 — 承認プロセスを経ない管理者による語の追加機能
- `F-13`: 方言モード対応 — アクセント以外の語形バリエーション投票
- `F-14`: フッター法的文書 — 利用規約、プライバシーポリシー、使い方ガイド

## 3. 機能詳細

### F-09: Cookie認証システム

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 年齢 | enum: 10s/20s/30s/40s/50s/60s/70s+ | 初回訪問時必須入力 |
| **入力** | 性別 | enum: male/female/other/prefer_not_to_say | 初回訪問時必須入力 |
| **入力** | 都道府県 | enum: 都道府県コード | 初回訪問時必須入力 |
| **処理** | Cookie生成 | UUIDv4によるデバイスIDを生成し、属性情報と共にCookieに保存 | |
| **処理** | 属性検証 | 既存Cookieの有無確認、期限切れの場合は再登録画面表示 | |
| **処理** | 投票権限確認 | Cookieに記録された属性情報を元に投票権限を付与 | |
| **出力 (正常時)** | 登録完了 | "登録が完了しました。投票をお楽しみください。" メッセージと共にメイン画面へ遷移 | |
| **出力 (正常時)** | Cookie設定 | HttpOnly、Secure、SameSite=Strict設定でCookieを30日間保存 | |
| **出力 (異常時)** | 入力エラー | "必須項目を全て入力してください" エラーメッセージを該当フィールドに表示 | |

**技術仕様**:
- Cookieキー名: `accent_vote_user`
- Cookie値: JSON形式 `{deviceId, age, gender, prefecture, registeredAt, lastVoteAt}`
- 有効期限: 30日間（自動延長なし）
- セキュリティ: HttpOnly, Secure, SameSite=Strict

### F-10: 都道府県別ランキング表示

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 都道府県選択 | enum: 都道府県コード + "全国" | デフォルトはユーザーの登録都道府県 |
| **入力** | 期間指定 | enum: 7d/30d/all | デフォルト30d |
| **入力** | 表示件数 | enum: 10/20/50 | デフォルト20 |
| **処理** | 地域別集計 | 選択都道府県内の投票データを期間・語別に集計 | |
| **処理** | ランキング算出 | 投票数降順でランキングを計算、前期間との比較も実施 | |
| **処理** | 統計情報取得 | 選択地域の総投票数、参加者数（推定）、アクセント多様性指数を算出 | |
| **出力 (正常時)** | ランキング一覧 | 順位、語、読み、投票数、最頻アクセント、前回順位差を表形式で表示 | |
| **出力 (正常時)** | 地域統計サマリ | 「北海道では○○語が人気です（○票）」形式の地域特徴コメント表示 | |
| **出力 (正常時)** | 比較機能 | 他都道府県との順位比較ボタン（最大3地域まで並列表示） | |
| **出力 (異常時)** | データ不足 | "選択地域の投票データが不足しています（最低50票必要）" メッセージ表示 | |

**UX設計**:
- レスポンシブ対応で地図連動表示
- 都道府県選択はドロップダウンと地図クリックの両対応
- スクロールで追加読み込み（無限スクロール）
- CSVエクスポート機能（研究用途）

### F-11: 日本地図アクセント分布可視化

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 対象語選択 | 語ID / 整数 | 語詳細画面からの遷移、または検索 |
| **入力** | 表示モード | enum: majority/diversity/participation | デフォルトmajority |
| **処理** | 都道府県別集計 | 各都道府県での最頻アクセント型と票数を計算 | |
| **処理** | 色分け計算 | アクセント型ごとの色割り当て（頭高=赤、平板=青、中高=緑、尾高=黄） | |
| **処理** | 地図データ生成 | GeoJSON形式で都道府県境界と色情報を統合 | |
| **処理** | 統計情報算出 | 地域クラスタリング分析、言語地理学的特徴の抽出 | |
| **出力 (正常時)** | 色分け地図表示 | 各都道府県を最頻アクセント色で塗り分け、投票数に応じて濃淡調整 | |
| **出力 (正常時)** | 凡例表示 | アクセント型別の色凡例と全国分布率の円グラフ表示 | |
| **出力 (正常時)** | ホバー詳細 | 都道府県ホバー時に「北海道: 頭高型 64% (234票)」の詳細表示 | |
| **出力 (正常時)** | クラスター分析 | 「東日本・西日本で明確な違いが見られます」等の分析コメント自動生成 | |
| **出力 (異常時)** | データ不足地域 | 投票数10票未満の都道府県はグレー表示「データ不足」 | |

**技術仕様**:
- ライブラリ: ECharts + GeoJSON
- 色設計: ColorBrewer準拠のアクセシビリティ対応
- インタラクション: ズーム、パン、クリックで詳細表示
- アニメーション: データ更新時のスムーズな色変化

### F-12: 管理者単語直接追加

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 管理者認証 | JWT + role:admin | 管理者専用画面アクセス時 |
| **入力** | 見出し語 | 文字列 / 30文字以内 / ひらがな・カタカナ・漢字 | 必須 |
| **入力** | 読み | 文字列 / 50文字以内 / ひらがな・カタカナ | 必須 |
| **入力** | 別表記 | 文字列 / 100文字以内 / カンマ区切り | 任意 |
| **入力** | カテゴリ | enum: 一般語/専門語/方言/固有名詞/研究用 | 必須 |
| **入力** | 公開フラグ | boolean | デフォルトtrue |
| **入力** | 推奨アクセント | enum: atamadaka/heiban/nakadaka/odaka | 参考情報として記録 |
| **入力** | 出典・備考 | text / 500文字以内 | 研究用メタデータ |
| **処理** | 即座公開 | 承認プロセスを経ずにstatus='approved'で即座にwords テーブルに登録 | |
| **処理** | 重複チェック | 見出し語・読みの組み合わせで既存語との重複を確認、管理者には警告のみ | |
| **処理** | 監査ログ | 管理者による追加操作を詳細ログとして記録 | |
| **出力 (正常時)** | 登録完了 | "語「○○」が正常に登録され、公開されました" 成功メッセージ表示 | |
| **出力 (正常時)** | 語詳細画面遷移 | 登録完了後、新しい語の詳細・投票画面に自動遷移 | |
| **出力 (異常時)** | 重複警告 | "類似語が存在します: [一覧] 続行しますか？" 確認ダイアログ表示 | |

**権限設計**:
- 管理者ロール: admin、moderator
- アクセス制限: 特定IPアドレスからのみアクセス可能
- 監査機能: 全操作をデータベースログとファイルログに記録

### F-13: 方言モード対応

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **入力** | 投票モード選択 | enum: accent/dialect | 単語登録時に選択 |
| **入力** | 方言選択肢（方言モード時）| 文字列配列 / 各50文字以内 / 2-8選択肢 | 投稿者が選択肢を定義 |
| **入力** | 地域説明 | text / 200文字以内 | "関西では○○と言います" 等の説明 |
| **処理** | モード別表示制御 | アクセントモードは4固定、方言モードは可変選択肢で表示 | |
| **処理** | 投票データ分離 | accent_votes（アクセント用）、dialect_votes（方言用）テーブルで管理 | |
| **処理** | 統計計算 | 方言モードは語形別の地域分布を計算 | |
| **出力 (正常時)** | 方言投票画面 | 「この意味を表す言葉は？」として複数選択肢をカード形式で表示 | |
| **出力 (正常時)** | 方言分布地図 | 選択された語形を色分けして地図上に可視化 | |
| **出力 (正常時)** | 使用例表示 | 各方言選択肢に使用例文を表示「『お腹すいた』→『腹減った』」 | |
| **出力 (異常時)** | 選択肢不足エラー | "方言モードでは最低2つの選択肢が必要です" エラー表示 | |

**データ構造**:
```sql
-- 単語モード追加
ALTER TABLE words ADD COLUMN mode ENUM('accent', 'dialect') DEFAULT 'accent';
-- 方言選択肢
CREATE TABLE dialect_options (
  id SERIAL PRIMARY KEY,
  word_id INT REFERENCES words(id),
  option_text VARCHAR(50) NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### F-14: フッター法的文書

| 区分 | 名称/説明 | 型/制約/フォーマット | 備考 |
|:---|:---|:---|:---|
| **処理** | 静的ページ生成 | Next.js Static Generation で SEO対応済み静的ページ生成 | |
| **処理** | アクセシビリティ対応 | WCAG 2.1 AA準拠のHTML構造とARIA属性 | |
| **出力 (正常時)** | 利用規約ページ | `/terms` - サービス利用条件、禁止事項、免責事項 | |
| **出力 (正常時)** | プライバシーポリシー | `/privacy` - Cookie使用、データ収集・利用、第三者提供 | |
| **出力 (正常時)** | 使い方ガイド | `/guide` - 投票方法、アクセント記号の読み方、FAQ | |
| **出力 (正常時)** | フッターリンク | 全ページ下部に3文書へのリンクを配置 | |

**文書内容骨子**:
- **利用規約**: 研究目的利用、商用利用禁止、投稿内容の責任
- **プライバシーポリシー**: Cookie利用目的明記、統計目的での利用、個人特定の回避
- **使い方ガイド**: アクセント型の説明、方言モードの使い方、効果的な投票方法

## 4. ビジネスルール

- **Cookie有効期限**: 30日間固定、自動延長なし、期限切れ時は再登録必須
- **都道府県別表示最小閾値**: ランキング表示は最低50票、地図表示は最低10票必要
- **管理者権限制限**: 特定IPアドレスからのアクセスのみ許可、全操作をログ記録
- **方言モード選択肢制限**: 最低2個、最大8個の選択肢、50文字以内
- **色分け統一規則**: 全地図表示で同一アクセント型は同一色を使用
- **データ匿名化**: 都道府県レベルより詳細な地域データは収集・表示しない
- **投票データ保持期間**: 個人と紐付かない統計データのみ永続保持

## 5. 設定ファイル・環境変数

| 項目名 | デフォルト値 | 必須 | 説明 |
|:---|:---:|:---:|:---|
| `COOKIE_SECRET_KEY` | - | Yes | Cookie暗号化用のシークレットキー |
| `ADMIN_ALLOWED_IPS` | `127.0.0.1` | No | 管理者アクセス許可IPアドレスリスト（カンマ区切り） |
| `MAP_MIN_VOTES_DISPLAY` | `10` | No | 地図表示に必要な最小投票数 |
| `RANKING_MIN_VOTES_DISPLAY` | `50` | No | ランキング表示に必要な最小投票数 |
| `DIALECT_MAX_OPTIONS` | `8` | No | 方言モードの最大選択肢数 |
| `COOKIE_EXPIRE_DAYS` | `30` | No | Cookie有効期限（日） |
| `ANALYSIS_CACHE_TTL` | `3600` | No | 分析結果キャッシュ時間（秒） |

## 6. 非機能要件

| 項目 | 要求レベル | 備考 |
|:---|:---|:---|
| **地図表示性能** | 都道府県データ読み込み1秒以内 | EChartsの最適化とCDN配信 |
| **Cookie処理性能** | 初回登録・認証処理0.5秒以内 | |
| **ランキング生成** | 5万投票データでも2秒以内に表示 | Redis キャッシュ活用 |
| **セキュリティ** | Cookie暗号化、XSS・CSRF対策 | |
| **プライバシー保護** | 個人特定不可能な匿名化 | |
| **アクセシビリティ** | スクリーンリーダー対応、キーボード操作 | |
| **SEO対応** | 各地域・語のページで適切なメタタグ | |

## 7. 用語集

- **方言モード**: アクセントではなく語形・表現の地域差を調査するモード
- **アクセント分布**: 各都道府県での4つのアクセント型の投票比率
- **クラスター分析**: 類似したアクセントパターンを持つ地域のグループ化
- **デバイスID**: Cookieに保存される匿名の一意識別子（UUIDv4）
- **属性情報**: 年齢・性別・都道府県の3つの基本デモグラフィック情報
- **統計閾値**: 有意なデータとして扱うために必要な最小投票数

## 8. 外部依存

- **ECharts**: 日本地図・統計グラフ表示ライブラリ
- **GeoJSON**: 都道府県境界データ（国土地理院標準）
- **ColorBrewer**: アクセシビリティ対応の色設計ライブラリ
- **UUID Generator**: デバイスID生成用ライブラリ

## 9. 実装優先度

### 高優先度 (Phase 1)
1. **F-09**: Cookie認証システム - JWT廃止による軽量化
2. **F-10**: 都道府県別ランキング - ユーザー体験向上の要

### 中優先度 (Phase 2) 
3. **F-11**: 日本地図可視化 - 可視化機能の強化
4. **F-14**: 法的文書整備 - 公開前に必須

### 低優先度 (Phase 3)
5. **F-12**: 管理者直接追加 - 運用効率化
6. **F-13**: 方言モード - 機能拡張

## 10. データベース設計変更

### 追加テーブル
```sql
-- 匿名ユーザー情報（Cookie管理）
CREATE TABLE anonymous_users (
    device_id UUID PRIMARY KEY,
    age_group VARCHAR(10) NOT NULL,
    gender VARCHAR(20) NOT NULL,
    prefecture_code VARCHAR(5) NOT NULL,
    registered_at TIMESTAMP DEFAULT NOW(),
    last_active_at TIMESTAMP DEFAULT NOW()
);

-- 方言投票用
CREATE TABLE dialect_votes (
    id SERIAL PRIMARY KEY,
    word_id INT REFERENCES words(id),
    device_id UUID REFERENCES anonymous_users(device_id),
    selected_option_id INT REFERENCES dialect_options(id),
    voted_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(word_id, device_id)
);

-- 都道府県別統計（方言用）
CREATE TABLE word_prefecture_dialect_stats (
    word_id INT REFERENCES words(id),
    prefecture_code VARCHAR(5) NOT NULL,
    option_id INT REFERENCES dialect_options(id),
    vote_count INT DEFAULT 0,
    PRIMARY KEY (word_id, prefecture_code, option_id)
);
```

## 11. API設計追加

### Cookie認証関連
- `POST /api/auth/anonymous` - 匿名ユーザー登録
- `GET /api/auth/verify-cookie` - Cookie認証確認
- `PUT /api/auth/refresh-session` - セッション更新

### ランキング・統計関連
- `GET /api/rankings/prefecture/:code` - 都道府県別ランキング
- `GET /api/stats/map/:wordId` - 地図用統計データ
- `GET /api/stats/comparison` - 地域比較データ

### 管理者機能
- `POST /api/admin/words/direct` - 管理者直接語追加
- `GET /api/admin/audit-logs` - 監査ログ取得

### 方言機能
- `POST /api/votes/dialect` - 方言投票
- `GET /api/words/:id/dialect-stats` - 方言統計

## 12. 確認が必要な項目

1. **F-08機能の詳細確認**: 既存の投稿承認管理機能の現在の実装状況
2. **地図色設計**: 各アクセント型の色選択について研究者・デザイナーとの調整
3. **プライバシーポリシー詳細**: GDPR・個人情報保護法への具体的対応方針
4. **管理者運用体制**: 管理者アカウントの作成・管理・権限移譲の手順
5. **分析機能の精度**: クラスター分析・言語地理学的特徴抽出の具体的アルゴリズム
6. **方言データ品質**: 方言選択肢の監修・品質管理体制

## 13. 改訂履歴

| 版 | 日付 | 変更内容 | 担当者 |
|:---|:---|:---|:---|
| 1.0 | 2025-08-29 | 初版作成 | Claude Code |
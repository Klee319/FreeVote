# フロントエンド投票機能エラーハンドリング改善

## 修正日時
2025-01-04

## 概要
フロントエンドの投票機能におけるエラーハンドリングを全面的に改善し、HTTPステータスコード別の適切な処理とユーザビリティの向上を実現しました。

## 修正対象ファイル
1. `accent-vote-site/lib/api.ts`
2. `accent-vote-site/app/words/[id]/page.tsx`
3. `accent-vote-site/components/features/accent/AccentVotingSection.tsx`

## 主な修正内容

### 1. api.ts - submitVote関数の改善
#### Line 66-155 付近

**改善点：**
- HTTPステータスコード別の詳細なエラーハンドリングを実装
- レスポンスのJSON解析エラーに対する安全な処理を追加
- エラー時の詳細なログ出力（statusCode、responseData含む）
- DeviceIDをX-Device-IDヘッダーでも送信するように改善

**ステータスコード別の処理：**
```javascript
- 400: バリデーションエラー → 「入力データが無効です」
- 403: 権限エラー → 「この操作を実行する権限がありません」
- 404: 語が見つからない → 「指定された語が見つかりません」
- 409: 重複投票 → 「この語には既に投票済みです。他の語への投票をお願いします」
- 429: レート制限 → 「投票の制限に達しました。しばらく待ってから再度お試しください」
- 500-504: サーバーエラー → 「サーバーエラーが発生しました。しばらくしてから再度お試しください」
```

### 2. api.ts - canVote関数の改善
#### Line 180-240 付近

**改善点：**
- レスポンス形式の正規化（data.canVote、data.hasVoted対応）
- DeviceIDをX-Device-IDヘッダーで送信
- サーバーエラー時はデフォルトで投票可能にする（UX向上）
- 投票済み判定の改善（existingVoteプロパティ対応）

### 3. WordDetailPage - 投票処理の改善
#### Line 47-130 付近

**改善点：**
- エラーログの詳細化（statusCode、responseData含む）
- ステータスコード別のカスタムエラーメッセージ
- 409エラー時のcanVoteキャッシュ無効化
- DeviceID不在時の明確なエラーメッセージ
- 投票前の各種バリデーション強化

### 4. AccentVotingSection - UI/UX改善
#### Line 75-90 付近

**改善点：**
- 投票処理中のローディング表示（スピナー付き）
- 投票済みメッセージの改善（「他の語への投票をお願いします」）
- 視覚的なフィードバックの強化

## 技術的な改善点

### エラーハンドリングの階層化
1. **API層（api.ts）**
   - HTTPステータスコードの解析と適切なエラーメッセージへの変換
   - レスポンス解析エラーの安全な処理
   - エラーオブジェクトへのstatusCodeとresponseDataの付与

2. **コンポーネント層（WordDetailPage）**
   - エラータイプに応じたユーザーフレンドリーなメッセージ表示
   - 適切なキャッシュ無効化とデータ再取得
   - toast通知による視覚的フィードバック

3. **UI層（AccentVotingSection）**
   - ローディング状態の表示
   - 投票済み状態の明確な表示

### デバッグ機能の強化
- 開発環境での詳細なログ出力
- エラー時のスタックトレース表示（開発環境のみ）
- APIリクエスト/レスポンスの詳細ログ

## テスト実装
`accent-vote-site/tests/api-error-handling.test.js`にテストスクリプトを作成：
- 各HTTPステータスコードに対する期待される動作の確認
- エラーメッセージの適切性の検証
- ユーザビリティ改善項目の動作確認

## 効果と成果

### ユーザー体験の向上
1. **明確なエラーメッセージ**
   - ユーザーが次に取るべきアクションが明確に
   - エラーの原因が理解しやすく

2. **安定した動作**
   - サーバーエラー時でもUIがクラッシュしない
   - 適切なフォールバック処理

3. **視覚的フィードバック**
   - ローディング状態の表示
   - 成功/失敗の明確な通知

### 開発・運用の改善
1. **デバッグの容易さ**
   - 詳細なエラーログによる問題の迅速な特定
   - ステータスコードとレスポンスデータの記録

2. **保守性の向上**
   - コードの構造化とエラーハンドリングの一元化
   - テストによる動作保証

## 今後の推奨事項

1. **エラー監視の実装**
   - Sentryなどのエラー監視ツールの導入
   - エラー発生率のトラッキング

2. **リトライ機能の実装**
   - ネットワークエラー時の自動リトライ
   - exponential backoffの実装

3. **オフライン対応**
   - Service Workerによるオフライン時の処理
   - キューイングシステムの実装

## 関連ファイル
- バックエンド修正: `backend/src/controllers/votes.controller.ts`
- バックエンドサービス: `backend/src/services/vote.service.ts`
- テストスクリプト: `accent-vote-site/tests/api-error-handling.test.js`